// Prisma Schema for Presentation Designer SaaS
// Similar to Gamma - AI-powered presentation generation

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

// ============================================
// AUTHENTICATION MODELS
// ============================================

model User {
  id            String    @id @default(cuid())
  email         String    @unique
  phone         String?   @unique // For SMS OTP
  name          String?
  password      String? // null for OAuth users
  emailVerified DateTime?
  phoneVerified DateTime?
  image         String?
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  // Relations
  accounts            Account[]
  sessions            Session[]
  projects            Project[]
  subscription        Subscription?
  tags                Tag[]
  activityLogs        ActivityLog[]
  organizationMembers OrganizationMember[]
  marketplaceTemplates MarketplaceTemplate[]
  templateReviews     TemplateReview[]
  emailPreferences    EmailPreferences?
  otpLogs             OtpLog[]

  @@index([createdAt])
  @@index([subscriptionTier])
  @@index([subscriptionStatus])
  @@index([role])
  @@map("users")
}

// Email notification preferences
model EmailPreferences {
  id               String   @id @default(cuid())
  userId           String   @unique
  loginOtp         Boolean  @default(true)  // OTP login codes
  passwordReset    Boolean  @default(true)  // Password reset codes
  marketingEmails  Boolean  @default(false) // Newsletters
  projectUpdates   Boolean  @default(true)  // Collaboration emails
  securityAlerts   Boolean  @default(true)  // Security notifications
  productUpdates   Boolean  @default(true)  // Product updates
  
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("email_preferences")
}

// OTP audit log for security and debugging
model OtpLog {
  id          String   @id @default(cuid())
  userId      String?
  identifier  String   // email or phone
  channel     String   // email or sms
  purpose     String   // login, password_reset, etc.
  success     Boolean  @default(false)
  ipAddress   String?
  userAgent   String?
  
  createdAt   DateTime @default(now())
  
  user        User?    @relation(fields: [userId], references: [id], onDelete: SetNull)

  @@index([identifier, purpose])
  @@index([createdAt])
  @@index([userId])
  @@map("otp_logs")
}

model Account {
  id                String  @id @default(cuid())
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String? @db.Text
  access_token      String? @db.Text
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String? @db.Text
  session_state     String?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
  @@index([userId])
  @@index([provider])
  @@map("accounts")
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([expires])
  @@map("sessions")
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
  @@map("verification_tokens")
}

// ============================================
// CORE APPLICATION MODELS
// ============================================

enum ProjectType {
  PRESENTATION
  DOCUMENT
}

enum ProjectStatus {
  DRAFT
  PUBLISHED
  ARCHIVED
}

model Project {
  id          String        @id @default(cuid())
  title       String
  description String?
  type        ProjectType   @default(PRESENTATION)
  status      ProjectStatus @default(DRAFT)
  approvalStatus String? // pending_review, approved, rejected, changes_requested

  // Theme settings
  themeId String?
  theme   Theme?  @relation(fields: [themeId], references: [id])

  // Design system
  designSystemId String?
  designSystem   DesignSystem? @relation(fields: [designSystemId], references: [id])

  // Sharing settings
  isPublic   Boolean @default(false)
  shareToken String? @unique

  // AI generation metadata
  generatedFromPrompt String? @db.Text
  tone                String?
  audience            String?
  metadata            Json?

  // Timestamps
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  publishedAt DateTime?
  deletedAt   DateTime?

  // Relations
  ownerId String
  owner   User    @relation(fields: [ownerId], references: [id], onDelete: Cascade)
  slides  Slide[]
  blocks  Block[]
  tags    Tag[]
  collaborationSessions CollaborationSession[]
  projectVersions ProjectVersion[]

  @@index([ownerId])
  @@index([ownerId, createdAt])
  @@index([shareToken])
  @@index([status])
  @@index([visibility])
  @@index([themeId])
  @@index([createdAt])
  @@map("projects")
}

model Slide {
  id        String @id @default(cuid())
  projectId String
  order     Int
  layout    String @default("default") // layout template name
  createdById String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  deletedAt DateTime?

  project Project @relation(fields: [projectId], references: [id], onDelete: Cascade)
  blocks  Block[]

  @@index([projectId])
  @@index([projectId, order])
  @@index([createdAt])
  @@map("slides")
}

enum BlockType {
  HEADING
  SUBHEADING
  PARAGRAPH
  BULLET_LIST
  NUMBERED_LIST
  IMAGE
  CODE
  QUOTE
  DIVIDER
  TABLE
  EMBED
  CHART
  VIDEO
  AUDIO
  TIMELINE
  COMPARISON
  STATS_GRID
  CALL_TO_ACTION
}

model Block {
  id        String    @id @default(cuid())
  projectId String
  slideId   String?
  blockType BlockType
  content   Json // Flexible content storage
  order     Int
  createdById String?

  // Styling overrides
  style Json? // Custom styling for this block

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  deletedAt DateTime? 

  project Project @relation(fields: [projectId], references: [id], onDelete: Cascade)
  slide   Slide?  @relation(fields: [slideId], references: [id], onDelete: Cascade)

  @@index([projectId])
  @@index([slideId])
  @@map("blocks")
}

// ============================================
// THEME SYSTEM
// ============================================

model Theme {
  id          String  @id @default(cuid())
  name        String
  description String?
  isDefault   Boolean @default(false)
  isPremium   Boolean @default(false)

  // Theme configuration
  colors  Json // { primary, secondary, background, text, accent }
  fonts   Json // { heading, body }
  spacing Json // { base, scale }

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  projects Project[]

  @@map("themes")
}

// ============================================
// SUBSCRIPTION & BILLING
// ============================================

enum SubscriptionPlan {
  FREE
  PRO
  ENTERPRISE
}

enum SubscriptionStatus {
  ACTIVE
  CANCELED
  PAST_DUE
  TRIALING
  PAUSED
}

model Subscription {
  id     String             @id @default(cuid())
  userId String             @unique
  plan   SubscriptionPlan   @default(FREE)
  status SubscriptionStatus @default(ACTIVE)

  // Stripe integration
  stripeCustomerId     String? @unique
  stripeSubscriptionId String? @unique
  stripePriceId        String?

  // Usage limits
  projectsLimit      Int @default(3)
  aiGenerationsLimit Int @default(10)
  aiGenerationsUsed  Int @default(0)

  // Billing period
  currentPeriodStart DateTime?
  currentPeriodEnd   DateTime?
  cancelAtPeriodEnd  Boolean   @default(false)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("subscriptions")
}

// ============================================
// USAGE & ANALYTICS
// ============================================

model AIGeneration {
  id        String  @id @default(cuid())
  userId    String
  projectId String?

  prompt   String @db.Text
  response Json
  tokens   Int
  model    String

  createdAt DateTime @default(now())

  @@index([userId])
  @@index([userId, createdAt])
  @@index([createdAt])
  @@index([model])
  @@map("ai_generations")
}

model Asset {
  id       String @id @default(cuid())
  userId   String
  filename String
  url      String
  mimeType String
  size     Int

  createdAt DateTime @default(now())

  @@index([userId])
  @@index([createdAt])
  @@index([mimeType])
  @@map("assets")
}

// ============================================
// REAL-TIME COLLABORATION
// ============================================

model CollaborationSession {
  id          String  @id @default(cuid())
  projectId   String
  userId      String
  socketId    String
  cursorX     Float?
  cursorY     Float?
  cursorSlide Int?
  isActive    Boolean @default(true)
  color       String // User's cursor color
  startedAt   DateTime @default(now())
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  project Project @relation(fields: [projectId], references: [id], onDelete: Cascade)

  @@index([projectId])
  @@index([userId])
  @@index([isActive])
  @@index([startedAt])
  @@map("collaboration_sessions")
}

model ProjectCollaborator {
  id         String           @id @default(cuid())
  projectId  String
  userId     String
  role       CollaboratorRole @default(VIEWER)
  invitedBy  String?
  invitedAt  DateTime         @default(now())
  acceptedAt DateTime?

  @@unique([projectId, userId])
  @@index([projectId])
  @@index([userId])
  @@map("project_collaborators")
}

enum CollaboratorRole {
  OWNER
  EDITOR
  COMMENTER
  VIEWER
}

model Comment {
  id        String  @id @default(cuid())
  projectId String
  slideId   String?
  blockId   String?
  userId    String
  content   String  @db.Text
  resolved  Boolean @default(false)
  pinned    Boolean @default(false)
  parentId  String? // For reply threads

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([projectId])
  @@index([slideId])
  @@index([userId])
  @@index([resolved])
  @@index([createdAt])
  @@index([parentId])
  @@map("comments")
}

model ProjectVersion {
  id        String  @id @default(cuid())
  projectId String
  version   Int
  snapshot  Json // Full project snapshot
  message   String? // Version message/description
  createdBy String

  createdAt DateTime @default(now())

  project Project @relation(fields: [projectId], references: [id], onDelete: Cascade)

  @@unique([projectId, version])
  @@index([projectId])
  @@map("project_versions")
}

// ============================================
// VOICE-TO-SLIDE GENERATION
// ============================================

model VoiceRecording {
  id            String                @id @default(cuid())
  userId        String
  projectId     String?
  filename      String
  url           String
  duration      Float // Duration in seconds
  transcription String?               @db.Text
  status        VoiceProcessingStatus @default(UPLOADING)

  createdAt   DateTime  @default(now())
  processedAt DateTime?

  @@index([userId])
  @@index([projectId])
  @@map("voice_recordings")
}

enum VoiceProcessingStatus {
  UPLOADING
  TRANSCRIBING
  GENERATING
  COMPLETED
  FAILED
}

// ============================================
// PRESENTATION ANALYTICS
// ============================================

model PresentationView {
  id        String  @id @default(cuid())
  projectId String
  viewerId  String? // Anonymous if null
  sessionId String // Unique session identifier
  ipAddress String?
  userAgent String?
  referrer  String?

  startedAt     DateTime  @default(now())
  endedAt       DateTime?
  totalDuration Int? // Total time in seconds

  slideViews SlideView[]

  @@index([projectId])
  @@index([sessionId])
  @@map("presentation_views")
}

model SlideView {
  id                 String @id @default(cuid())
  presentationViewId String
  slideId            String
  slideIndex         Int

  enterTime    DateTime  @default(now())
  exitTime     DateTime?
  duration     Int? // Time spent in seconds
  interactions Int       @default(0) // Click count

  presentationView PresentationView @relation(fields: [presentationViewId], references: [id], onDelete: Cascade)

  @@index([presentationViewId])
  @@index([slideId])
  @@map("slide_views")
}

model EngagementHeatmap {
  id         String @id @default(cuid())
  projectId  String
  slideId    String
  x          Float // Percentage position
  y          Float
  clickCount Int    @default(1)

  updatedAt DateTime @updatedAt

  @@unique([projectId, slideId, x, y])
  @@index([projectId])
  @@map("engagement_heatmaps")
}

model AnalyticsSnapshot {
  id           String   @id @default(cuid())
  projectId    String
  date         DateTime @db.Date
  views        Int      @default(0)
  uniqueViews  Int      @default(0)
  avgDuration  Float    @default(0)
  dropOffSlide Int? // Slide where most viewers left

  @@unique([projectId, date])
  @@index([projectId])
  @@map("analytics_snapshots")
}

// ============================================
// INTEGRATIONS
// ============================================

model Integration {
  id           String              @id @default(cuid())
  userId       String
  provider     IntegrationProvider
  accessToken  String              @db.Text
  refreshToken String?             @db.Text
  expiresAt    DateTime?
  metadata     Json? // Provider-specific data
  isActive     Boolean             @default(true)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([userId, provider])
  @@index([userId])
  @@map("integrations")
}

enum IntegrationProvider {
  ZOOM
  SLACK
  TEAMS
  GOOGLE_DRIVE
  FIGMA
  NOTION
  DROPBOX
}

model IntegrationWebhook {
  id            String        @id @default(cuid())
  integrationId String
  eventType     String
  payload       Json
  status        WebhookStatus @default(PENDING)

  createdAt   DateTime  @default(now())
  processedAt DateTime?

  @@index([integrationId])
  @@map("integration_webhooks")
}

enum WebhookStatus {
  PENDING
  PROCESSED
  FAILED
}

// ============================================
// CUSTOM AI MODELS & PERSONALIZATION
// ============================================

model BrandProfile {
  id             String   @id @default(cuid())
  userId         String   @unique
  companyName    String?
  brandVoice     String?  @db.Text // Tone/style description
  industry       String?
  targetAudience String?  @db.Text
  keywords       String[] // Brand-specific terms
  colorPalette   Json? // Brand colors
  logoUrl        String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("brand_profiles")
}

model TrainingDocument {
  id         String         @id @default(cuid())
  userId     String
  filename   String
  url        String
  content    String?        @db.Text // Extracted text
  embeddings Json? // Vector embeddings for RAG
  status     DocumentStatus @default(UPLOADING)

  createdAt   DateTime  @default(now())
  processedAt DateTime?

  @@index([userId])
  @@map("training_documents")
}

enum DocumentStatus {
  UPLOADING
  PROCESSING
  READY
  FAILED
}

model AIPersonalization {
  id             String  @id @default(cuid())
  userId         String
  projectId      String?
  promptTemplate String? @db.Text // Custom system prompt
  examples       Json? // Few-shot examples
  preferences    Json? // Style preferences

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([userId])
  @@map("ai_personalizations")
}

// ============================================
// ENTERPRISE FEATURES
// ============================================

model Organization {
  id     String  @id @default(cuid())
  name   String
  slug   String  @unique
  logo   String?
  domain String? @unique // For SSO domain verification

  // White-labeling
  brandingEnabled Boolean @default(false)
  primaryColor    String?
  secondaryColor  String?
  customCss       String? @db.Text
  customDomain    String? @unique

  // Settings
  settings Json?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  members    OrganizationMember[]
  ssoConfigs SSOConfig[]

  @@map("organizations")
}

model OrganizationMember {
  id             String  @id @default(cuid())
  organizationId String
  userId         String
  role           OrgRole @default(MEMBER)

  createdAt DateTime @default(now())

  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  user         User         @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([organizationId, userId])
  @@index([organizationId])
  @@index([userId])
  @@map("organization_members")
}

enum OrgRole {
  OWNER
  ADMIN
  MEMBER
}

model SSOConfig {
  id             String      @id @default(cuid())
  organizationId String
  provider       SSOProvider

  // SAML Configuration
  entityId    String?
  ssoUrl      String?
  certificate String? @db.Text

  // OIDC Configuration
  clientId     String?
  clientSecret String?
  issuerUrl    String?

  isActive Boolean @default(false)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@unique([organizationId, provider])
  @@map("sso_configs")
}

enum SSOProvider {
  SAML
  OIDC
  AZURE_AD
  OKTA
  GOOGLE_WORKSPACE
}

model AuditLog {
  id             String  @id @default(cuid())
  organizationId String?
  userId         String
  action         String
  resource       String
  resourceId     String?
  oldValue       Json?
  newValue       Json?
  ipAddress      String?
  userAgent      String?

  createdAt DateTime @default(now())

  @@index([organizationId])
  @@index([userId])
  @@index([action])
  @@map("audit_logs")
}

model TeamInvitation {
  id             String   @id @default(cuid())
  organizationId String
  email          String
  role           OrgRole  @default(MEMBER)
  token          String   @unique
  invitedBy      String
  expiresAt      DateTime

  createdAt DateTime @default(now())

  @@index([organizationId])
  @@index([email])
  @@map("team_invitations")
}

// ============================================
// OFFLINE & PWA SUPPORT
// ============================================

model OfflineCache {
  id          String   @id @default(cuid())
  userId      String
  projectId   String
  version     Int
  data        Json // Cached project data
  lastSynced  DateTime @default(now())
  pendingSync Boolean  @default(false)

  @@unique([userId, projectId])
  @@index([userId])
  @@map("offline_caches")
}

model SyncQueue {
  id        String        @id @default(cuid())
  userId    String
  projectId String
  operation SyncOperation
  data      Json
  priority  Int           @default(0)
  attempts  Int           @default(0)
  status    SyncStatus    @default(PENDING)
  error     String?

  createdAt   DateTime  @default(now())
  processedAt DateTime?

  @@index([userId])
  @@index([projectId])
  @@index([status])
  @@map("sync_queue")
}

enum SyncOperation {
  CREATE
  UPDATE
  DELETE
}

enum SyncStatus {
  PENDING
  PROCESSING
  COMPLETED
  FAILED
}

// ============================================
// TAGS
// ============================================

model Tag {
  id        String   @id @default(cuid())
  name      String
  color     String
  userId    String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user     User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  projects Project[]

  @@unique([userId, name])
  @@index([userId])
  @@map("tags")
}

// ============================================
// WEBHOOKS
// ============================================

model Webhook {
  id              String    @id @default(cuid())
  userId          String
  url             String
  events          String[]
  secret          String
  active          Boolean   @default(true)
  failureCount    Int       @default(0)
  lastTriggeredAt DateTime?
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  logs WebhookLog[]

  @@index([userId])
  @@index([active])
  @@map("webhooks")
}

model WebhookLog {
  id         String   @id @default(cuid())
  webhookId  String
  event      String
  payload    Json
  success    Boolean
  statusCode Int?
  response   String?  @db.Text
  error      String?
  createdAt  DateTime @default(now())

  webhook Webhook @relation(fields: [webhookId], references: [id], onDelete: Cascade)

  @@index([webhookId])
  @@index([createdAt])
  @@map("webhook_logs")
}

// ============================================
// INTERACTIVE EMBEDS (Polls, Q&A, Forms)
// ============================================

enum InteractiveEmbedType {
  POLL
  QA
  FORM
  QUIZ
  WORD_CLOUD
}

model InteractiveEmbed {
  id        String               @id @default(cuid())
  projectId String
  slideId   String
  type      InteractiveEmbedType
  title     String
  config    Json // Embed-specific configuration
  isActive  Boolean              @default(true)
  closedAt  DateTime?
  createdAt DateTime             @default(now())
  updatedAt DateTime             @updatedAt

  responses InteractiveResponse[]

  @@index([projectId])
  @@index([slideId])
  @@map("interactive_embeds")
}

model InteractiveResponse {
  id          String   @id @default(cuid())
  embedId     String
  userId      String?
  sessionId   String?
  response    Json? // Main response data
  data        Json? // Additional response data
  responseType String? // poll_vote, qa_question, form_submission, quiz_submission, wordcloud_submission
  responderId String? // For anonymous responses
  createdAt   DateTime @default(now())

  embed InteractiveEmbed @relation(fields: [embedId], references: [id], onDelete: Cascade)

  @@index([embedId])
  @@map("interactive_responses")
}

// ============================================
// DATA-DRIVEN CHARTS
// ============================================

enum DataSourceType {
  CSV
  GOOGLE_SHEETS
  API
  MANUAL
}

model DataSource {
  id          String         @id @default(cuid())
  projectId   String
  name        String
  type        DataSourceType
  config      Json // Source-specific config (URL, credentials, etc.)
  data        Json? // Cached data
  lastFetched DateTime? // Last time data was fetched
  lastSyncAt  DateTime?
  refreshRate Int? // in minutes
  createdAt   DateTime       @default(now())
  updatedAt   DateTime       @updatedAt

  charts DataChart[]

  @@index([projectId])
  @@map("data_sources")
}

model DataChart {
  id           String   @id @default(cuid())
  projectId    String
  slideId      String
  blockId      String
  dataSourceId String
  title        String?
  chartType    String // bar, line, pie, scatter, etc.
  config       Json // Chart configuration
  cachedData   Json? // Cached processed data
  data         Json? // Raw data
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  dataSource DataSource? @relation(fields: [dataSourceId], references: [id])

  @@index([projectId])
  @@index([slideId])
  @@map("data_charts")
}

// ============================================
// TEMPLATE MARKETPLACE
// ============================================

enum MarketplaceTemplateStatus {
  DRAFT
  PENDING_REVIEW
  APPROVED
  REJECTED
  PUBLISHED
}

model MarketplaceTemplate {
  id            String                    @id @default(cuid())
  authorId      String
  title         String
  description   String?                   @db.Text
  thumbnail     String?
  category      String
  tags          String[]
  price         Float                     @default(0)
  pricing       String                    @default("free") // free, premium
  isFree        Boolean                   @default(false)
  status        MarketplaceTemplateStatus @default(DRAFT)
  downloadCount Int                       @default(0)
  slideCount    Int                       @default(0)
  reviewCount   Int                       @default(0)
  rating        Float? // Average rating
  content       Json? // Template content structure
  previewImages String[]                  @default([])
  templateData  Json // Full template structure
  createdAt     DateTime                  @default(now())
  updatedAt     DateTime                  @updatedAt
  publishedAt   DateTime?

  author    User              @relation(fields: [authorId], references: [id])
  reviews   TemplateReview[]
  purchases TemplatePurchase[]
  downloads TemplateDownload[]

  @@index([authorId])
  @@index([category])
  @@index([status])
  @@map("marketplace_templates")
}

model TemplateReview {
  id         String   @id @default(cuid())
  templateId String
  userId     String
  rating     Int // 1-5
  comment    String?  @db.Text
  createdAt  DateTime @default(now())

  template MarketplaceTemplate @relation(fields: [templateId], references: [id], onDelete: Cascade)
  user      User               @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([templateId, userId])
  @@index([templateId])
  @@map("template_reviews")
}

model TemplatePurchase {
  id             String   @id @default(cuid())
  templateId     String
  userId         String
  amount         Float
  price          Float
  paymentIntentId String?
  createdAt      DateTime @default(now())

  template MarketplaceTemplate @relation(fields: [templateId], references: [id])

  @@index([templateId])
  @@index([userId])
  @@map("template_purchases")
}

// ============================================
// DESIGN SYSTEM TOKENS
// ============================================

model DesignSystem {
  id             String   @id @default(cuid())
  organizationId String?
  userId         String?
  name           String
  isDefault      Boolean  @default(false)
  colors         Json // Color tokens
  typography     Json // Typography tokens
  spacing        Json // Spacing tokens
  shadows        Json? // Shadow tokens
  borders        Json? // Border tokens
  cssVariables   Json? // CSS variables
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  projects Project[]

  @@index([organizationId])
  @@index([userId])
  @@map("design_systems")
}

// ============================================
// ACCESSIBILITY REPORTS
// ============================================

model AccessibilityReport {
  id               String   @id @default(cuid())
  projectId        String
  score            Float // 0-100
  grade            String // A, B, C, D, F
  totalIssues      Int // Total number of issues found
  issues           Json // Array of accessibility issues
  issuesByCategory Json? // Issues grouped by category
  issuesBySeverity Json? // Issues grouped by severity
  suggestions      Json // AI-generated suggestions
  checkedAt        DateTime @default(now())

  @@index([projectId])
  @@map("accessibility_reports")
}

// ============================================
// MULTILINGUAL TRANSLATIONS
// ============================================

enum TranslationStatus {
  PENDING
  IN_PROGRESS
  COMPLETED
  FAILED
}

model ProjectTranslation {
  id                String   @id @default(cuid())
  projectId         String   @unique
  sourceLanguage    String
  targetLanguages   String[]
  primaryLanguage   String   @default("en")
  availableLanguages String[]
  translationProgress Json? // Progress tracking
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  slides SlideTranslation[]

  @@index([projectId])
  @@map("project_translations")
}

model SlideTranslation {
  id                   String            @id @default(cuid())
  projectTranslationId String
  slideId              String
  blockId              String
  language             String
  translations         Json // Block translations
  translatedContent    String? // Translated content for the block
  status               TranslationStatus @default(PENDING)
  isManuallyEdited     Boolean           @default(false)
  createdAt            DateTime          @default(now())
  updatedAt            DateTime          @updatedAt

  projectTranslation ProjectTranslation @relation(fields: [projectTranslationId], references: [id], onDelete: Cascade)

  @@unique([slideId, blockId, language])
  @@index([projectTranslationId])
  @@index([slideId])
  @@map("slide_translations")
}

// ============================================
// NARRATION & VIDEO EXPORT
// ============================================

enum ExportStatus {
  PENDING
  PROCESSING
  COMPLETED
  FAILED
}

model NarrationProject {
  id        String   @id @default(cuid())
  projectId String
  voice     String // TTS voice ID
  speed     Float    @default(1.0)
  status    String   @default("generating") // generating, completed, failed
  totalDuration Float @default(0) // Total duration in seconds
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  slides  NarrationSlide[]
  exports VideoExportJob[]

  @@index([projectId])
  @@map("narration_projects")
}

model NarrationSlide {
  id                 String   @id @default(cuid())
  narrationProjectId String
  slideId            String
  slideNumber        Int
  order              Int      @default(0)
  speakerNotes       String   @db.Text
  audioUrl           String?
  audioDuration      Float? // in seconds
  duration           Float? // Alternative duration field
  createdAt          DateTime @default(now())
  updatedAt          DateTime @updatedAt

  narrationProject NarrationProject @relation(fields: [narrationProjectId], references: [id], onDelete: Cascade)
  blocks           NarrationBlock[]

  @@index([narrationProjectId])
  @@index([slideId])
  @@map("narration_slides")
}

model NarrationBlock {
  id             String @id @default(cuid())
  narrationSlideId String
  blockId        String
  content        String @db.Text
  audioUrl       String?
  duration       Float?
  order          Int
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  narrationSlide NarrationSlide @relation(fields: [narrationSlideId], references: [id], onDelete: Cascade)

  @@index([narrationSlideId])
  @@index([blockId])
  @@map("narration_blocks")
}

model VideoExportJob {
  id                 String       @id @default(cuid())
  narrationProjectId String?
  projectId          String? // For backward compatibility
  format             String // mp4, webm, mp3
  resolution         String? // 720p, 1080p, 4k
  status             ExportStatus @default(PENDING)
  progress           Float        @default(0)
  includeNarration   Boolean      @default(true)
  slideTransition    String       @default("fade") // none, fade, slide
  slideDuration      Int          @default(5) // seconds
  outputUrl          String?
  error              String?
  startedAt          DateTime?
  completedAt        DateTime?
  createdAt          DateTime     @default(now())

  narrationProject NarrationProject? @relation(fields: [narrationProjectId], references: [id], onDelete: Cascade)

  @@index([narrationProjectId])
  @@map("video_export_jobs")
}

// ============================================
// CONTENT GOVERNANCE
// ============================================

model ApprovalWorkflow {
  id                String   @id @default(cuid())
  organizationId    String
  name              String
  description       String?
  stages            Json // Array of workflow stages
  requiredApprovers Json // Stage requirements
  autoPublish       Boolean  @default(false)
  isActive          Boolean  @default(true)
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  requests ApprovalRequest[]

  @@index([organizationId])
  @@map("approval_workflows")
}

model ApprovalRequest {
  id           String   @id @default(cuid())
  projectId    String
  workflowId   String
  currentStage String
  status       String // draft, pending_review, approved, rejected
  requestedBy  String
  requestedAt  DateTime @default(now())
  approvals    Json // Array of approval records
  comments     Json // Array of comments
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  workflow ApprovalWorkflow @relation(fields: [workflowId], references: [id])

  @@index([projectId])
  @@index([workflowId])
  @@map("approval_requests")
}

model RequiredDisclaimer {
  id             String   @id @default(cuid())
  organizationId String
  name           String
  content        String   @db.Text
  placement      String // first_slide, last_slide, all_slides, custom
  categories     Json // Array of applicable categories
  isRequired     Boolean  @default(true)
  isActive       Boolean  @default(true)
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  @@index([organizationId])
  @@map("required_disclaimers")
}

model ContentLock {
  id        String    @id @default(cuid())
  projectId String
  slideId   String?
  blockId   String?
  lockType  String // full, partial, none
  reason    String?
  lockedBy  String
  lockedAt  DateTime  @default(now())
  expiresAt DateTime?

  @@index([projectId])
  @@map("content_locks")
}

model GovernancePolicy {
  id               String   @id @default(cuid())
  organizationId   String
  name             String
  rules            Json // Array of policy rules
  enforcementLevel String // warn, block
  isActive         Boolean  @default(true)
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt

  @@index([organizationId])
  @@map("governance_policies")
}

// ============================================
// TEAM ANALYTICS
// ============================================

model ActivityLog {
  id         String   @id @default(cuid())
  userId     String
  action     String
  targetType String
  targetId   String
  metadata   Json?
  createdAt  DateTime @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([targetType, targetId])
  @@index([createdAt])
  @@map("activity_logs")
}

// ============================================
// TRANSLATION MODELS (Additional)
// ============================================

model TranslationJob {
  id               String   @id @default(cuid())
  projectId        String
  targetLanguage   String
  status           String   @default("pending") // pending, processing, completed, failed
  progress         Int      @default(0)
  totalBlocks      Int      @default(0)
  translatedBlocks Int      @default(0)
  error            String?
  startedAt        DateTime?
  createdAt        DateTime @default(now())
  completedAt      DateTime?

  @@index([projectId])
  @@index([status])
  @@map("translation_jobs")
}

// ============================================
// NARRATION & SPEAKER NOTES (Additional)
// ============================================

model SpeakerNote {
  id            String   @id @default(cuid())
  slideId       String   @unique
  content       String   @db.Text
  voice         String?
  audioUrl      String?
  duration      Int?
  isAIGenerated Boolean  @default(false)
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  @@index([slideId])
  @@map("speaker_notes")
}

// ============================================
// TEMPLATE MARKETPLACE (Additional)
// ============================================

model TemplateSubmission {
  id          String   @id @default(cuid())
  templateId  String
  authorId    String
  status      String   @default("pending") // pending, approved, rejected
  reviewNotes String?  @db.Text
  feedback    String?  @db.Text
  submittedAt DateTime @default(now())
  reviewedAt  DateTime?

  @@index([templateId])
  @@index([authorId])
  @@index([status])
  @@map("template_submissions")
}

model TemplateDownload {
  id         String   @id @default(cuid())
  templateId String
  userId     String
  projectId  String?
  createdAt  DateTime @default(now())

  template MarketplaceTemplate @relation(fields: [templateId], references: [id])

  @@index([templateId])
  @@index([userId])
  @@map("template_downloads")
}

model AuthorEarnings {
  id         String   @id @default(cuid())
  authorId   String
  templateId String
  amount     Float
  status     String   @default("pending") // pending, paid
  earnedAt   DateTime @default(now())

  @@index([authorId])
  @@index([templateId])
  @@map("author_earnings")
}
