// Prisma Schema for Presentation Designer SaaS
// Similar to Gamma - AI-powered presentation generation

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

// ============================================
// AUTHENTICATION MODELS
// ============================================

model User {
  id            String    @id @default(cuid())
  email         String    @unique
  phone         String?   @unique // For SMS OTP
  name          String?
  password      String? // null for OAuth users
  role          String?   @default("USER") // ADMIN, USER
  subscriptionTier String? @default("FREE") // FREE, PRO, ENTERPRISE
  subscriptionStatus String? @default("ACTIVE") // ACTIVE, INACTIVE, CANCELLED
  emailVerified DateTime?
  phoneVerified DateTime?
  image         String?
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  // Relations
  accounts            Account[]
  sessions            Session[]
  projects            Project[]
  subscription        Subscription?
  tags                Tag[]
  activityLogs        ActivityLog[]
  organizationMembers OrganizationMember[]
  marketplaceTemplates MarketplaceTemplate[]
  templateReviews     TemplateReview[]
  emailPreferences    EmailPreferences?
  otpLogs             OtpLog[]
  uploads             Upload[]
  imagePatterns       PresentationImagePattern?

  @@index([createdAt])
  @@index([subscriptionTier])
  @@index([subscriptionStatus])
  @@index([role])
  @@map("users")
}

// Email notification preferences
model EmailPreferences {
  id               String   @id @default(cuid())
  userId           String   @unique
  loginOtp         Boolean  @default(true)  // OTP login codes
  passwordReset    Boolean  @default(true)  // Password reset codes
  marketingEmails  Boolean  @default(false) // Newsletters
  projectUpdates   Boolean  @default(true)  // Collaboration emails
  securityAlerts   Boolean  @default(true)  // Security notifications
  productUpdates   Boolean  @default(true)  // Product updates
  
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("email_preferences")
}

// OTP audit log for security and debugging
model OtpLog {
  id          String   @id @default(cuid())
  userId      String?
  identifier  String   // email or phone
  channel     String   // email or sms
  purpose     String   // login, password_reset, etc.
  success     Boolean  @default(false)
  ipAddress   String?
  userAgent   String?
  
  createdAt   DateTime @default(now())
  
  user        User?    @relation(fields: [userId], references: [id], onDelete: SetNull)

  @@index([identifier, purpose])
  @@index([createdAt])
  @@index([userId])
  @@map("otp_logs")
}

model Account {
  id                String  @id @default(cuid())
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String? @db.Text
  access_token      String? @db.Text
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String? @db.Text
  session_state     String?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
  @@index([userId])
  @@index([provider])
  @@map("accounts")
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([expires])
  @@map("sessions")
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
  @@map("verification_tokens")
}

// ============================================
// CORE APPLICATION MODELS
// ============================================

enum ProjectType {
  PRESENTATION
  DOCUMENT
}

enum ProjectStatus {
  DRAFT
  PUBLISHED
  ARCHIVED
}

model Project {
  id          String        @id @default(cuid())
  title       String
  description String?
  type        ProjectType   @default(PRESENTATION)
  status      ProjectStatus @default(DRAFT)
  approvalStatus String? // pending_review, approved, rejected, changes_requested

  // Theme settings
  themeId String?
  theme   Theme?  @relation(fields: [themeId], references: [id])

  // Design system
  designSystemId String?
  designSystem   DesignSystem? @relation(fields: [designSystemId], references: [id])

  // Sharing settings
  isPublic   Boolean @default(false)
  shareToken String? @unique

  // AI generation metadata
  generatedFromPrompt String? @db.Text
  tone                String?
  audience            String?
  metadata            Json?

  // Timestamps
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  publishedAt DateTime?
  deletedAt   DateTime?

  // Relations
  ownerId String
  owner   User    @relation(fields: [ownerId], references: [id], onDelete: Cascade)
  slides  Slide[]
  blocks  Block[]
  tags    Tag[]
  collaborationSessions CollaborationSession[]
  projectVersions ProjectVersion[]
  uploads Upload[]
  imageUsages ImageUsage[]

  @@index([ownerId])
  @@index([ownerId, createdAt])
  @@index([shareToken])
  @@index([status])
  @@index([themeId])
  @@index([createdAt])
  @@map("projects")
}

model Slide {
  id        String @id @default(cuid())
  projectId String
  title     String?
  content   Json? // Slide content as JSON
  order     Int
  layout    String @default("default") // layout template name
  createdById String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  deletedAt DateTime?

  project Project @relation(fields: [projectId], references: [id], onDelete: Cascade)
  blocks  Block[]
  uploads Upload[]
  imageUsages ImageUsage[]

  @@index([projectId])
  @@index([projectId, order])
  @@index([createdAt])
  @@map("slides")
}

model Tag {
  id     String @id @default(cuid())
  userId String
  name   String
  color  String

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user    User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  projects Project[]

  @@unique([userId, name])
  @@index([userId])
  @@map("tags")
}

enum BlockType {
  HEADING
  SUBHEADING
  PARAGRAPH
  BULLET_LIST
  NUMBERED_LIST
  IMAGE
  CODE
  QUOTE
  DIVIDER
  TABLE
  EMBED
  CHART
  VIDEO
  AUDIO
  TIMELINE
  COMPARISON
  STATS_GRID
  CALL_TO_ACTION
}

model Block {
  id        String    @id @default(cuid())
  projectId String
  slideId   String?
  blockType BlockType
  content   Json // Flexible content storage
  order     Int
  createdById String?
  version   Int       @default(1) // Optimistic locking version

  // Styling overrides
  style Json? // Custom styling for this block

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  deletedAt DateTime? 

  project Project @relation(fields: [projectId], references: [id], onDelete: Cascade)
  slide   Slide?  @relation(fields: [slideId], references: [id], onDelete: Cascade)

  @@index([projectId])
  @@index([slideId])
  @@index([projectId, version])
  @@map("blocks")
}

// ============================================
// THEME SYSTEM
// ============================================

model Theme {
  id          String  @id @default(cuid())
  name        String
  description String?
  isDefault   Boolean @default(false)
  isPremium   Boolean @default(false)

  // Theme configuration
  colors  Json // { primary, secondary, background, text, accent }
  fonts   Json // { heading, body }
  spacing Json // { base, scale }

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  projects Project[]

  @@map("themes")
}

// ============================================
// SUBSCRIPTION & BILLING
// ============================================

enum SubscriptionPlan {
  FREE
  PRO
  ENTERPRISE
}

enum SubscriptionStatus {
  ACTIVE
  CANCELED
  PAST_DUE
  TRIALING
  PAUSED
}

model Subscription {
  id     String             @id @default(cuid())
  userId String             @unique
  plan   SubscriptionPlan   @default(FREE)
  status SubscriptionStatus @default(ACTIVE)

  // Stripe integration
  stripeCustomerId     String? @unique
  stripeSubscriptionId String? @unique
  stripePriceId        String?

  // Usage limits
  projectsLimit      Int @default(3)
  aiGenerationsLimit Int @default(10)
  aiGenerationsUsed  Int @default(0)

  // Billing period
  currentPeriodStart DateTime?
  currentPeriodEnd   DateTime?
  cancelAtPeriodEnd  Boolean   @default(false)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("subscriptions")
}

// ============================================
// USAGE & ANALYTICS
// ============================================

model AIGeneration {
  id        String  @id @default(cuid())
  userId    String
  projectId String?

  prompt   String @db.Text
  response Json
  tokens   Int
  model    String

  createdAt DateTime @default(now())

  @@index([userId])
  @@index([userId, createdAt])
  @@index([createdAt])
  @@index([model])
  @@map("ai_generations")
}

model Asset {
  id       String @id @default(cuid())
  userId   String
  filename String
  url      String
  mimeType String
  size     Int

  createdAt DateTime @default(now())

  @@index([userId])
  @@index([createdAt])
  @@index([mimeType])
  @@map("assets")
}

// Enhanced upload tracking with image recognition support
model Upload {
  id            String   @id @default(cuid())
  userId        String
  projectId     String?
  slideId       String?
  source        String   // 'ai', 'unsplash', 'pexels', 'pixabay', 'url', 'local'
  sourceId      String?  // Original ID from stock photo provider
  url           String
  localPath     String?
  thumbnailUrl  String?
  filename      String
  mimeType      String
  size          Int      @default(0)
  width         Int?
  height        Int?
  description   String?  @db.Text
  tags          String[] @default([])
  author        String?
  authorUrl     String?
  license       String?
  metadata      Json     @default("{}")
  
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  // Relations
  user          User?    @relation(fields: [userId], references: [id], onDelete: Cascade)
  project       Project? @relation(fields: [projectId], references: [id], onDelete: SetNull)
  slide         Slide?   @relation(fields: [slideId], references: [id], onDelete: SetNull)
  
  embedding     ImageEmbedding?
  usages        ImageUsage[]
  similarityAsSource ImageSimilarityCache[] @relation("SourceUpload")
  similarityAsTarget ImageSimilarityCache[] @relation("TargetUpload")

  @@index([userId])
  @@index([projectId])
  @@index([slideId])
  @@index([source])
  @@index([sourceId])
  @@index([createdAt])
  @@index([tags])
  @@map("uploads")
}

// Image embeddings for ML-powered similarity matching
model ImageEmbedding {
  id             String   @id @default(cuid())
  uploadId       String   @unique
  embedding      Float[]  // Vector embedding
  embeddingModel String   @default("openai-clip")
  dimension      Int      @default(512)
  
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  upload         Upload   @relation(fields: [uploadId], references: [id], onDelete: Cascade)

  @@index([uploadId])
  @@map("image_embeddings")
}

// Track image usage in presentations
model ImageUsage {
  id         String    @id @default(cuid())
  uploadId   String
  projectId  String
  slideId    String?
  blockId    String?
  position   Int?
  usageType  String    @default("content") // 'content', 'background', 'thumbnail'
  addedAt    DateTime  @default(now())
  removedAt  DateTime?

  upload     Upload    @relation(fields: [uploadId], references: [id], onDelete: Cascade)
  project    Project   @relation(fields: [projectId], references: [id], onDelete: Cascade)
  slide      Slide?    @relation(fields: [slideId], references: [id], onDelete: SetNull)

  @@index([uploadId])
  @@index([projectId])
  @@index([slideId])
  @@index([blockId])
  @@index([addedAt])
  @@index([uploadId, projectId, removedAt])
  @@map("image_usage")
}

// Cache similarity scores for performance
model ImageSimilarityCache {
  id              String   @id @default(cuid())
  sourceUploadId  String
  targetUploadId  String
  similarityScore Float    // Cosine similarity (0-1)
  calculatedAt    DateTime @default(now())

  sourceUpload    Upload   @relation("SourceUpload", fields: [sourceUploadId], references: [id], onDelete: Cascade)
  targetUpload    Upload   @relation("TargetUpload", fields: [targetUploadId], references: [id], onDelete: Cascade)

  @@unique([sourceUploadId, targetUploadId])
  @@index([sourceUploadId])
  @@index([targetUploadId])
  @@index([similarityScore])
  @@map("image_similarity_cache")
}

// ML-based user image preferences and patterns
model PresentationImagePattern {
  id                  String   @id @default(cuid())
  userId              String   @unique
  presentationType    String?  // 'business', 'creative', 'educational'
  industryTags        String[] @default([])
  preferredSources    String[] @default([])
  avgImagesPerSlide   Float?
  commonImageTags     String[] @default([])
  colorPreferences    Json     @default("{}")
  stylePreferences    Json     @default("{}")
  lastUpdated         DateTime @default(now()) @updatedAt

  user                User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([industryTags])
  @@map("presentation_image_patterns")
}

// ============================================
// REAL-TIME COLLABORATION
// ============================================

model CollaborationSession {
  id          String  @id @default(cuid())
  projectId   String
  userId      String
  socketId    String
  cursorX     Float?
  cursorY     Float?
  cursorSlide Int?
  isActive    Boolean @default(true)
  color       String // User's cursor color
  startedAt   DateTime @default(now())
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  project Project @relation(fields: [projectId], references: [id], onDelete: Cascade)

  @@index([projectId])
  @@index([userId])
  @@index([isActive])
  @@index([startedAt])
  @@map("collaboration_sessions")
}

model ProjectCollaborator {
  id         String           @id @default(cuid())
  projectId  String
  userId     String
  role       CollaboratorRole @default(VIEWER)
  invitedBy  String?
  invitedAt  DateTime         @default(now())
  acceptedAt DateTime?

  @@unique([projectId, userId])
  @@index([projectId])
  @@index([userId])
  @@map("project_collaborators")
}

enum CollaboratorRole {
  OWNER
  EDITOR
  COMMENTER
  VIEWER
}

model Comment {
  id        String  @id @default(cuid())
  projectId String
  slideId   String?
  blockId   String?
  userId    String
  content   String  @db.Text
  resolved  Boolean @default(false)
  pinned    Boolean @default(false)
  parentId  String? // For reply threads

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([projectId])
  @@index([slideId])
  @@index([userId])
  @@index([resolved])
  @@index([createdAt])
  @@index([parentId])
  @@map("comments")
}

model ProjectVersion {
  id        String  @id @default(cuid())
  projectId String
  version   Int
  snapshot  Json // Full project snapshot
  message   String? // Version message/description
  createdBy String

  createdAt DateTime @default(now())

  project Project @relation(fields: [projectId], references: [id], onDelete: Cascade)

  @@unique([projectId, version])
  @@index([projectId])
  @@map("project_versions")
}

// ============================================
// VOICE-TO-SLIDE GENERATION
// ============================================

model VoiceRecording {
  id            String                @id @default(cuid())
  userId        String
  projectId     String?
  filename      String
  url           String
  duration      Float // Duration in seconds
  transcription String?               @db.Text
  status        VoiceProcessingStatus @default(UPLOADING)

  createdAt   DateTime  @default(now())
  processedAt DateTime?

  @@index([userId])
  @@index([projectId])
  @@map("voice_recordings")
}

enum VoiceProcessingStatus {
  UPLOADING
  TRANSCRIBING
  GENERATING
  COMPLETED
  FAILED
}

// ============================================
// PRESENTATION ANALYTICS
// ============================================

model PresentationView {
  id        String  @id @default(cuid())
  projectId String
  viewerId  String? // Anonymous if null
  sessionId String // Unique session identifier
  viewedAt  DateTime? // When the view was recorded
  ipAddress String?
  userAgent String?
  referrer  String?

  startedAt     DateTime  @default(now())
  endedAt       DateTime?
  totalDuration Int? // Total time in seconds

  slideViews SlideView[]

  @@index([projectId])
  @@index([sessionId])
  @@map("presentation_views")
}

model SlideView {
  id                 String @id @default(cuid())
  presentationViewId String
  slideId            String
  slideIndex         Int

  enterTime    DateTime  @default(now())
  exitTime     DateTime?
  duration     Int? // Time spent in seconds
  interactions Int       @default(0) // Click count

  presentationView PresentationView @relation(fields: [presentationViewId], references: [id], onDelete: Cascade)

  @@index([presentationViewId])
  @@index([slideId])
  @@map("slide_views")
}

model EngagementHeatmap {
  id         String @id @default(cuid())
  projectId  String
  slideId    String
  x          Float // Percentage position
  y          Float
  clickCount Int    @default(1)

  updatedAt DateTime @updatedAt

  @@unique([projectId, slideId, x, y])
  @@index([projectId])
  @@map("engagement_heatmaps")
}

model AnalyticsSnapshot {
  id           String   @id @default(cuid())
  projectId    String
  date         DateTime @db.Date
  views        Int      @default(0)
  uniqueViews  Int      @default(0)
  avgDuration  Float    @default(0)
  dropOffSlide Int? // Slide where most viewers left

  @@unique([projectId, date])
  @@index([projectId])
  @@map("analytics_snapshots")
}

// ============================================
// INTEGRATIONS
// ============================================

model Integration {
  id           String              @id @default(cuid())
  userId       String
  provider     IntegrationProvider
  accessToken  String              @db.Text
  refreshToken String?             @db.Text
  expiresAt    DateTime?
  metadata     Json? // Provider-specific data
  isActive     Boolean             @default(true)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([userId, provider])
  @@index([userId])
  @@map("integrations")
}

enum IntegrationProvider {
  ZOOM
  SLACK
  TEAMS
  GOOGLE_DRIVE
  FIGMA
  NOTION
  DROPBOX
}

model IntegrationWebhook {
  id            String        @id @default(cuid())
  integrationId String
  eventType     String
  payload       Json
  status        WebhookStatus @default(PENDING)

  createdAt   DateTime  @default(now())
  processedAt DateTime?

  @@index([integrationId])
  @@map("integration_webhooks")
}

enum WebhookStatus {
  PENDING
  PROCESSED
  FAILED
}

// ============================================
// CUSTOM AI MODELS & PERSONALIZATION
// ============================================

model BrandProfile {
  id             String   @id @default(cuid())
  userId         String   @unique
  companyName    String?
  brandVoice     String?  @db.Text // Tone/style description
  industry       String?
  targetAudience String?  @db.Text
  keywords       String[] // Brand-specific terms
  colorPalette   Json? // Brand colors
  logoUrl        String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("brand_profiles")
}

model TrainingDocument {
  id         String         @id @default(cuid())
  userId     String
  filename   String
  url        String
  content    String?        @db.Text // Extracted text
  embeddings Json? // Vector embeddings for RAG
  status     DocumentStatus @default(UPLOADING)

  createdAt   DateTime  @default(now())
  processedAt DateTime?

  @@index([userId])
  @@map("training_documents")
}

enum DocumentStatus {
  UPLOADING
  PROCESSING
  READY
  FAILED
}

model AIPersonalization {
  id             String  @id @default(cuid())
  userId         String
  projectId      String?
  promptTemplate String? @db.Text // Custom system prompt
  examples       Json? // Few-shot examples
  preferences    Json? // Style preferences

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([userId])
  @@map("ai_personalizations")
}

// ============================================
// ENTERPRISE FEATURES
// ============================================

model Organization {
  id     String  @id @default(cuid())
  name   String
  slug   String  @unique
  plan   String? @default("FREE") // FREE, PRO, ENTERPRISE
  logo   String?
  domain String? @unique // For SSO domain verification

  // White-labeling
  brandingEnabled Boolean @default(false)
  primaryColor    String?
  secondaryColor  String?
  customCss       String? @db.Text
  customDomain    String? @unique

  // Settings
  settings Json?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  members    OrganizationMember[]
  ssoConfigs SSOConfig[]

  @@map("organizations")
}

model OrganizationMember {
  id             String  @id @default(cuid())
  organizationId String
  userId         String
  role           OrgRole @default(MEMBER)

  createdAt DateTime @default(now())

  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  user         User         @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([organizationId, userId])
  @@index([organizationId])
  @@index([userId])
  @@map("organization_members")
}

enum OrgRole {
  OWNER
  ADMIN
  MEMBER
}

model SSOConfig {
  id             String      @id @default(cuid())
  organizationId String
  provider       SSOProvider

  // SAML Configuration
  entityId    String?
  ssoUrl      String?
  certificate String? @db.Text

  // OIDC Configuration
  clientId     String?
  clientSecret String?
  issuerUrl    String?

  isActive Boolean @default(false)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@unique([organizationId, provider])
  @@map("sso_configs")
}

// Brand Kit for Organization Branding
model BrandKit {
  id             String   @id @default(cuid())
  organizationId String?
  userId         String?  // For personal brand kits
  name           String
  isDefault      Boolean  @default(false)

  // Colors
  primaryColor     String?
  secondaryColor   String?
  accentColor      String?
  backgroundColor  String?
  textColor        String?
  colorPalette     Json?   // Array of additional brand colors

  // Typography
  headingFont      String? // Font family for headings
  bodyFont         String? // Font family for body text
  fontSizes        Json?   // Custom font size scale

  // Logo & Images
  logoUrl          String?
  logoLight        String? // Logo for light backgrounds
  logoDark         String? // Logo for dark backgrounds
  favicon          String?
  coverImages      Json?   // Array of approved cover images

  // Assets
  icons            Json?   // Custom icon set URLs
  patterns         Json?   // Background patterns
  watermark        String? // Watermark image URL
  watermarkOpacity Float?  @default(0.3)

  // Voice & Tone
  voiceDescription String? @db.Text // Description of brand voice
  toneKeywords     Json?   // Array of tone keywords

  // Guidelines
  doList           Json?   // Array of do's
  dontList         Json?   // Array of don'ts
  styleGuideUrl    String? // Link to full style guide

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([organizationId])
  @@index([userId])
  @@map("brand_kits")
}

enum SSOProvider {
  SAML
  OIDC
  AZURE_AD
  OKTA
  GOOGLE_WORKSPACE
}

model AuditLog {
  id             String  @id @default(cuid())
  organizationId String?
  userId         String
  action         String
  resource       String
  resourceId     String?
  oldValue       Json?
  newValue       Json?
  ipAddress      String?
  userAgent      String?

  createdAt DateTime @default(now())

  @@index([organizationId])
  @@index([userId])
  @@index([action])
  @@map("audit_logs")
}

model TeamInvitation {
  id             String   @id @default(cuid())
  organizationId String
  email          String
  role           OrgRole  @default(MEMBER)
  token          String   @unique
  invitedBy      String
  expiresAt      DateTime

  createdAt DateTime @default(now())

  @@index([organizationId])
  @@index([email])
  @@map("team_invitations")
}

// ============================================
// OFFLINE & PWA SUPPORT
// ============================================

model OfflineCache {
  id          String   @id @default(cuid())
  userId      String
  projectId   String
  version     Int
  data        Json // Cached project data
  lastSynced  DateTime @default(now())
  pendingSync Boolean  @default(false)

  @@unique([userId, projectId])
  @@index([userId])
  @@map("offline_caches")
}

model SyncQueue {
  id        String        @id @default(cuid())
  userId    String
  projectId String
  operation SyncOperation
  data      Json
  priority  Int           @default(0)
  attempts  Int           @default(0)
  status    SyncStatus    @default(PENDING)
  error     String?

  createdAt   DateTime  @default(now())
  processedAt DateTime?

  @@index([userId])
  @@index([projectId])
  @@index([status])
  @@map("sync_queue")
}

enum SyncOperation {
  CREATE
  UPDATE
  DELETE
}

enum SyncStatus {
  PENDING
  PROCESSING
  COMPLETED
  FAILED
}

// ============================================
// WEBHOOKS
// ============================================

model Webhook {
  id              String    @id @default(cuid())
  userId          String
  url             String
  events          String[]
  secret          String
  active          Boolean   @default(true)
  failureCount    Int       @default(0)
  lastTriggeredAt DateTime?
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  logs WebhookLog[]

  @@index([userId])
  @@index([active])
  @@map("webhooks")
}

model WebhookLog {
  id         String   @id @default(cuid())
  webhookId  String
  event      String
  payload    Json
  success    Boolean
  statusCode Int?
  response   String?  @db.Text
  error      String?
  createdAt  DateTime @default(now())

  webhook Webhook @relation(fields: [webhookId], references: [id], onDelete: Cascade)

  @@index([webhookId])
  @@index([createdAt])
  @@map("webhook_logs")
}

// ============================================
// INTERACTIVE EMBEDS (Polls, Q&A, Forms)
// ============================================

enum InteractiveEmbedType {
  POLL
  QA
  FORM
  QUIZ
  WORD_CLOUD
}

model InteractiveEmbed {
  id        String               @id @default(cuid())
  projectId String
  slideId   String
  type      InteractiveEmbedType
  title     String
  config    Json // Embed-specific configuration
  isActive  Boolean              @default(true)
  closedAt  DateTime?
  createdAt DateTime             @default(now())
  updatedAt DateTime             @updatedAt

  responses InteractiveResponse[]

  @@index([projectId])
  @@index([slideId])
  @@map("interactive_embeds")
}

model InteractiveResponse {
  id          String   @id @default(cuid())
  embedId     String
  userId      String?
  sessionId   String?
  response    Json? // Main response data
  data        Json? // Additional response data
  responseType String? // poll_vote, qa_question, form_submission, quiz_submission, wordcloud_submission
  responderId String? // For anonymous responses
  createdAt   DateTime @default(now())

  embed InteractiveEmbed @relation(fields: [embedId], references: [id], onDelete: Cascade)

  @@index([embedId])
  @@map("interactive_responses")
}

// ============================================
// DATA-DRIVEN CHARTS
// ============================================

enum DataSourceType {
  CSV
  GOOGLE_SHEETS
  API
  MANUAL
}

model DataSource {
  id          String         @id @default(cuid())
  projectId   String
  name        String
  type        DataSourceType
  config      Json // Source-specific config (URL, credentials, etc.)
  data        Json? // Cached data
  lastFetched DateTime? // Last time data was fetched
  lastSyncAt  DateTime?
  refreshRate Int? // in minutes
  createdAt   DateTime       @default(now())
  updatedAt   DateTime       @updatedAt

  charts DataChart[]

  @@index([projectId])
  @@map("data_sources")
}

model DataChart {
  id           String   @id @default(cuid())
  projectId    String
  slideId      String
  blockId      String
  dataSourceId String
  title        String?
  chartType    String // bar, line, pie, scatter, etc.
  config       Json // Chart configuration
  cachedData   Json? // Cached processed data
  data         Json? // Raw data
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  dataSource DataSource? @relation(fields: [dataSourceId], references: [id])

  @@index([projectId])
  @@index([slideId])
  @@map("data_charts")
}

// ============================================
// TEMPLATE MARKETPLACE
// ============================================

enum MarketplaceTemplateStatus {
  DRAFT
  PENDING_REVIEW
  APPROVED
  REJECTED
  PUBLISHED
}

model MarketplaceTemplate {
  id            String                    @id @default(cuid())
  authorId      String
  title         String
  description   String?                   @db.Text
  thumbnail     String?
  category      String
  tags          String[]
  price         Float                     @default(0)
  pricing       String                    @default("free") // free, premium
  isFree        Boolean                   @default(false)
  status        MarketplaceTemplateStatus @default(DRAFT)
  downloadCount Int                       @default(0)
  slideCount    Int                       @default(0)
  reviewCount   Int                       @default(0)
  rating        Float? // Average rating
  content       Json? // Template content structure
  previewImages String[]                  @default([])
  templateData  Json // Full template structure
  createdAt     DateTime                  @default(now())
  updatedAt     DateTime                  @updatedAt
  publishedAt   DateTime?

  author    User              @relation(fields: [authorId], references: [id])
  reviews   TemplateReview[]
  purchases TemplatePurchase[]
  downloads TemplateDownload[]

  @@index([authorId])
  @@index([category])
  @@index([status])
  @@map("marketplace_templates")
}

model TemplateReview {
  id         String   @id @default(cuid())
  templateId String
  userId     String
  rating     Int // 1-5
  comment    String?  @db.Text
  createdAt  DateTime @default(now())

  template MarketplaceTemplate @relation(fields: [templateId], references: [id], onDelete: Cascade)
  user      User               @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([templateId, userId])
  @@index([templateId])
  @@map("template_reviews")
}

model TemplatePurchase {
  id             String   @id @default(cuid())
  templateId     String
  userId         String
  amount         Float
  price          Float
  paymentIntentId String?
  createdAt      DateTime @default(now())

  template MarketplaceTemplate @relation(fields: [templateId], references: [id])

  @@index([templateId])
  @@index([userId])
  @@map("template_purchases")
}

// ============================================
// DESIGN SYSTEM TOKENS
// ============================================

model DesignSystem {
  id             String   @id @default(cuid())
  organizationId String?
  userId         String?
  name           String
  isDefault      Boolean  @default(false)
  colorTokens    Json? // Color tokens
  colors         Json // Color tokens
  typography     Json // Typography tokens
  spacing        Json // Spacing tokens
  shadows        Json? // Shadow tokens
  borders        Json? // Border tokens
  cssVariables   Json? // CSS variables
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  projects Project[]

  @@index([organizationId])
  @@index([userId])
  @@map("design_systems")
}

// ============================================
// ACCESSIBILITY REPORTS
// ============================================

model AccessibilityReport {
  id               String   @id @default(cuid())
  projectId        String
  score            Float // 0-100
  grade            String // A, B, C, D, F
  totalIssues      Int // Total number of issues found
  issues           Json // Array of accessibility issues
  issuesByCategory Json? // Issues grouped by category
  issuesBySeverity Json? // Issues grouped by severity
  suggestions      Json // AI-generated suggestions
  checkedAt        DateTime @default(now())

  @@index([projectId])
  @@map("accessibility_reports")
}

// ============================================
// MULTILINGUAL TRANSLATIONS
// ============================================

enum TranslationStatus {
  PENDING
  IN_PROGRESS
  COMPLETED
  FAILED
}

model ProjectTranslation {
  id                String   @id @default(cuid())
  projectId         String   @unique
  sourceLanguage    String
  targetLanguages   String[]
  primaryLanguage   String   @default("en")
  availableLanguages String[]
  translationProgress Json? // Progress tracking
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  slides SlideTranslation[]

  @@index([projectId])
  @@map("project_translations")
}

model SlideTranslation {
  id                   String            @id @default(cuid())
  projectTranslationId String
  slideId              String
  blockId              String
  language             String
  translations         Json // Block translations
  translatedContent    String? // Translated content for the block
  status               TranslationStatus @default(PENDING)
  isManuallyEdited     Boolean           @default(false)
  createdAt            DateTime          @default(now())
  updatedAt            DateTime          @updatedAt

  projectTranslation ProjectTranslation @relation(fields: [projectTranslationId], references: [id], onDelete: Cascade)

  @@unique([slideId, blockId, language])
  @@index([projectTranslationId])
  @@index([slideId])
  @@map("slide_translations")
}

// ============================================
// NARRATION & VIDEO EXPORT
// ============================================

enum ExportStatus {
  PENDING
  PROCESSING
  COMPLETED
  FAILED
}

model NarrationProject {
  id        String   @id @default(cuid())
  projectId String
  voice     String // TTS voice ID
  speed     Float    @default(1.0)
  status    String   @default("generating") // generating, completed, failed
  totalDuration Float @default(0) // Total duration in seconds
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  slides  NarrationSlide[]
  exports VideoExportJob[]

  @@index([projectId])
  @@map("narration_projects")
}

model NarrationSlide {
  id                 String   @id @default(cuid())
  narrationProjectId String
  slideId            String
  slideNumber        Int
  order              Int      @default(0)
  speakerNotes       String   @db.Text
  audioUrl           String?
  audioDuration      Float? // in seconds
  duration           Float? // Alternative duration field
  createdAt          DateTime @default(now())
  updatedAt          DateTime @updatedAt

  narrationProject NarrationProject @relation(fields: [narrationProjectId], references: [id], onDelete: Cascade)
  blocks           NarrationBlock[]

  @@index([narrationProjectId])
  @@index([slideId])
  @@map("narration_slides")
}

model NarrationBlock {
  id             String @id @default(cuid())
  narrationSlideId String
  blockId        String
  content        String @db.Text
  audioUrl       String?
  duration       Float?
  order          Int
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  narrationSlide NarrationSlide @relation(fields: [narrationSlideId], references: [id], onDelete: Cascade)

  @@index([narrationSlideId])
  @@index([blockId])
  @@map("narration_blocks")
}

model VideoExportJob {
  id                 String       @id @default(cuid())
  narrationProjectId String?
  projectId          String? // For backward compatibility
  format             String // mp4, webm, mp3
  resolution         String? // 720p, 1080p, 4k
  status             ExportStatus @default(PENDING)
  progress           Float        @default(0)
  includeNarration   Boolean      @default(true)
  slideTransition    String       @default("fade") // none, fade, slide
  slideDuration      Int          @default(5) // seconds
  outputUrl          String?
  error              String?
  startedAt          DateTime?
  completedAt        DateTime?
  createdAt          DateTime     @default(now())

  narrationProject NarrationProject? @relation(fields: [narrationProjectId], references: [id], onDelete: Cascade)

  @@index([narrationProjectId])
  @@map("video_export_jobs")
}

// ============================================
// CONTENT GOVERNANCE
// ============================================

model ApprovalWorkflow {
  id                String   @id @default(cuid())
  organizationId    String
  name              String
  description       String?
  stages            Json // Array of workflow stages
  requiredApprovers Json // Stage requirements
  autoPublish       Boolean  @default(false)
  isActive          Boolean  @default(true)
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  requests ApprovalRequest[]

  @@index([organizationId])
  @@map("approval_workflows")
}

model ApprovalRequest {
  id           String   @id @default(cuid())
  projectId    String
  workflowId   String
  currentStage String
  status       String // draft, pending_review, approved, rejected
  requestedBy  String
  requestedAt  DateTime @default(now())
  approvals    Json // Array of approval records
  comments     Json // Array of comments
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  workflow ApprovalWorkflow @relation(fields: [workflowId], references: [id])

  @@index([projectId])
  @@index([workflowId])
  @@map("approval_requests")
}

model RequiredDisclaimer {
  id             String   @id @default(cuid())
  organizationId String
  name           String
  content        String   @db.Text
  placement      String // first_slide, last_slide, all_slides, custom
  categories     Json // Array of applicable categories
  isRequired     Boolean  @default(true)
  isActive       Boolean  @default(true)
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  @@index([organizationId])
  @@map("required_disclaimers")
}

model ContentLock {
  id        String    @id @default(cuid())
  projectId String
  slideId   String?
  blockId   String?
  lockType  String // full, partial, none
  reason    String?
  lockedBy  String
  lockedAt  DateTime  @default(now())
  expiresAt DateTime?

  @@index([projectId])
  @@map("content_locks")
}

model GovernancePolicy {
  id               String   @id @default(cuid())
  organizationId   String
  name             String
  rules            Json // Array of policy rules
  enforcementLevel String // warn, block
  isActive         Boolean  @default(true)
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt

  @@index([organizationId])
  @@map("governance_policies")
}

// ============================================
// TEAM ANALYTICS
// ============================================

model ActivityLog {
  id         String   @id @default(cuid())
  userId     String
  action     String
  targetType String
  targetId   String
  metadata   Json?
  createdAt  DateTime @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([targetType, targetId])
  @@index([createdAt])
  @@map("activity_logs")
}

// ============================================
// TRANSLATION MODELS (Additional)
// ============================================

model TranslationJob {
  id               String   @id @default(cuid())
  projectId        String
  targetLanguage   String
  status           String   @default("pending") // pending, processing, completed, failed
  progress         Int      @default(0)
  totalBlocks      Int      @default(0)
  translatedBlocks Int      @default(0)
  error            String?
  startedAt        DateTime?
  createdAt        DateTime @default(now())
  completedAt      DateTime?

  @@index([projectId])
  @@index([status])
  @@map("translation_jobs")
}

// ============================================
// NARRATION & SPEAKER NOTES (Additional)
// ============================================

model SpeakerNote {
  id            String   @id @default(cuid())
  slideId       String   @unique
  content       String   @db.Text
  voice         String?
  audioUrl      String?
  duration      Int?
  isAIGenerated Boolean  @default(false)
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  @@index([slideId])
  @@map("speaker_notes")
}

// ============================================
// TEMPLATE MARKETPLACE (Additional)
// ============================================

model TemplateSubmission {
  id          String   @id @default(cuid())
  templateId  String
  authorId    String
  status      String   @default("pending") // pending, approved, rejected
  reviewNotes String?  @db.Text
  feedback    String?  @db.Text
  submittedAt DateTime @default(now())
  reviewedAt  DateTime?

  @@index([templateId])
  @@index([authorId])
  @@index([status])
  @@map("template_submissions")
}

model TemplateDownload {
  id         String   @id @default(cuid())
  templateId String
  userId     String
  projectId  String?
  createdAt  DateTime @default(now())

  template MarketplaceTemplate @relation(fields: [templateId], references: [id])

  @@index([templateId])
  @@index([userId])
  @@map("template_downloads")
}

model AuthorEarnings {
  id         String   @id @default(cuid())
  authorId   String
  templateId String
  amount     Float
  status     String   @default("pending") // pending, paid
  earnedAt   DateTime @default(now())

  @@index([authorId])
  @@index([templateId])
  @@map("author_earnings")
}

// ============================================
// AI CONTENT RESEARCH ASSISTANT
// ============================================

model ContentResearch {
  id           String   @id @default(cuid())
  userId       String
  projectId    String?
  topic        String
  query        String   @db.Text
  status       String   @default("pending") // pending, researching, completed, failed
  results      Json?    // Array of research results
  sources      ContentResearchSource[]
  summary      String?  @db.Text
  keywords     String[] @default([])
  metadata     Json?
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
  completedAt  DateTime?

  @@index([userId])
  @@index([projectId])
  @@index([status])
  @@map("content_research")
}

model ContentResearchSource {
  id            String   @id @default(cuid())
  researchId    String
  sourceType    String   // web, wikipedia, academic, news, custom_kb
  title         String
  url           String?
  content       String?  @db.Text
  snippet       String?  @db.Text
  relevanceScore Float?
  credibilityScore Float?
  publishedDate DateTime?
  author        String?
  metadata      Json?
  createdAt     DateTime @default(now())

  research ContentResearch @relation(fields: [researchId], references: [id], onDelete: Cascade)

  @@index([researchId])
  @@index([sourceType])
  @@map("content_research_sources")
}

// ============================================
// AI STORYBOARDING & NARRATIVE
// ============================================

model Storyboard {
  id              String   @id @default(cuid())
  userId          String
  projectId       String?
  title           String
  audienceType    String   // executive, technical, educational, marketing, creative
  presentationType String  // summary, deep_dive, pitch, tutorial
  duration        Int?     // estimated minutes
  narrativeArc    Json     // story structure
  sections        StoryboardSection[]
  pacing          Json?    // timing recommendations
  transitions     Json?    // suggested transitions
  status          String   @default("draft") // draft, generating, completed
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@index([userId])
  @@index([projectId])
  @@map("storyboards")
}

model StoryboardSection {
  id             String   @id @default(cuid())
  storyboardId   String
  title          String
  order          Int
  type           String   // intro, rising_action, climax, resolution, call_to_action
  duration       Int?     // seconds
  keyPoints      Json     // Array of key points
  suggestedLayout String?
  speakerNotes   String?  @db.Text
  transitionIn   String?
  transitionOut  String?
  createdAt      DateTime @default(now())

  storyboard Storyboard @relation(fields: [storyboardId], references: [id], onDelete: Cascade)

  @@index([storyboardId])
  @@map("storyboard_sections")
}

// ============================================
// AI A/B TESTING FOR DESIGNS
// ============================================

model ABTest {
  id            String   @id @default(cuid())
  userId        String
  projectId     String
  name          String
  description   String?
  status        String   @default("draft") // draft, running, completed, paused
  goalMetric    String   @default("engagement") // engagement, completion, click_through
  variants      ABTestVariant[]
  results       ABTestResult[]
  winnerVariantId String?
  sampleSize    Int      @default(100)
  currentSample Int      @default(0)
  confidenceLevel Float  @default(0.95)
  startedAt     DateTime?
  endedAt       DateTime?
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  @@index([userId])
  @@index([projectId])
  @@index([status])
  @@map("ab_tests")
}

model ABTestVariant {
  id           String   @id @default(cuid())
  testId       String
  name         String
  description  String?
  themeConfig  Json     // Theme configuration
  isControl    Boolean  @default(false)
  traffic      Float    @default(50) // Percentage of traffic
  impressions  Int      @default(0)
  conversions  Int      @default(0)
  engagementScore Float @default(0)
  avgViewTime  Float?   // Average view time in seconds
  bounceRate   Float?
  createdAt    DateTime @default(now())

  test    ABTest         @relation(fields: [testId], references: [id], onDelete: Cascade)
  results ABTestResult[]

  @@index([testId])
  @@map("ab_test_variants")
}

model ABTestResult {
  id          String   @id @default(cuid())
  testId      String
  variantId   String
  sessionId   String
  viewerId    String?
  engaged     Boolean  @default(false)
  completed   Boolean  @default(false)
  viewTime    Int?     // seconds
  interactions Int     @default(0)
  dropOffSlide Int?
  metadata    Json?
  createdAt   DateTime @default(now())

  test    ABTest        @relation(fields: [testId], references: [id], onDelete: Cascade)
  variant ABTestVariant @relation(fields: [variantId], references: [id], onDelete: Cascade)

  @@index([testId])
  @@index([variantId])
  @@index([sessionId])
  @@map("ab_test_results")
}

// ============================================
// VR/AR PRESENTATION MODE
// ============================================

model VRExport {
  id              String   @id @default(cuid())
  userId          String
  projectId       String
  format          String   @default("webxr") // webxr, a-frame, threejs
  status          String   @default("pending") // pending, processing, completed, failed
  config          Json     // VR configuration
  scenes          VRScene[]
  outputUrl       String?
  previewUrl      String?
  optimizedFor    String[] @default([]) // oculus, htc_vive, browser_vr
  fileSize        Int?
  error           String?
  createdAt       DateTime @default(now())
  completedAt     DateTime?

  @@index([userId])
  @@index([projectId])
  @@index([status])
  @@map("vr_exports")
}

model VRScene {
  id           String   @id @default(cuid())
  vrExportId   String
  slideId      String
  order        Int
  environment  String   @default("default") // skybox preset
  background360 String?  // 360 background URL
  objects3d    Json?    // 3D objects in scene
  transitions  Json?    // 3D transition config
  hotspots     Json?    // Interactive hotspots
  spatialAudio Json?    // Spatial audio config
  createdAt    DateTime @default(now())

  vrExport VRExport @relation(fields: [vrExportId], references: [id], onDelete: Cascade)

  @@index([vrExportId])
  @@map("vr_scenes")
}

model AROverlay {
  id           String   @id @default(cuid())
  userId       String
  projectId    String
  slideId      String?
  name         String
  type         String   // marker, surface, face, image_tracking
  markerUrl    String?
  content3d    Json     // 3D content configuration
  animations   Json?    // Animation sequences
  interactions Json?    // Touch/gesture interactions
  isActive     Boolean  @default(true)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  @@index([userId])
  @@index([projectId])
  @@map("ar_overlays")
}

// ============================================
// HOLOGRAPHIC PREVIEWS
// ============================================

model HolographicPreview {
  id              String   @id @default(cuid())
  userId          String
  projectId       String
  displayType     String   @default("looking_glass") // looking_glass, pepper_ghost, webgl_3d
  status          String   @default("pending") // pending, rendering, completed, failed
  config          Json     // Display-specific configuration
  quilts          Json?    // Quilt images for holographic display
  outputUrl       String?
  previewUrl      String?
  depth           Float    @default(1.0)
  viewAngle       Float    @default(45)
  error           String?
  createdAt       DateTime @default(now())
  completedAt     DateTime?

  @@index([userId])
  @@index([projectId])
  @@map("holographic_previews")
}

// ============================================
// BLOCKCHAIN & NFT OWNERSHIP
// ============================================

model NFTCollection {
  id              String   @id @default(cuid())
  userId          String
  name            String
  symbol          String
  description     String?  @db.Text
  contractAddress String?  @unique
  chainId         String   @default("ethereum") // ethereum, polygon, solana
  status          String   @default("draft") // draft, deploying, deployed
  mintPrice       Float?
  royaltyPercent  Float    @default(2.5)
  maxSupply       Int?
  mintedCount     Int      @default(0)
  metadata        Json?
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  nfts NFTMint[]

  @@index([userId])
  @@index([contractAddress])
  @@map("nft_collections")
}

model NFTMint {
  id              String   @id @default(cuid())
  collectionId    String?
  userId          String
  projectId       String?
  templateId      String?
  tokenId         String?  @unique
  transactionHash String?
  status          String   @default("pending") // pending, minting, minted, failed
  price           Float?
  chainId         String   @default("ethereum")
  ownerAddress    String?
  metadata        Json     // NFT metadata (name, description, image, attributes)
  ipfsHash        String?
  error           String?
  mintedAt        DateTime?
  createdAt       DateTime @default(now())

  collection NFTCollection? @relation(fields: [collectionId], references: [id])
  ownership  NFTOwnership[]
  royalties  NFTRoyalty[]

  @@index([collectionId])
  @@index([userId])
  @@index([projectId])
  @@index([tokenId])
  @@map("nft_mints")
}

model NFTOwnership {
  id            String   @id @default(cuid())
  nftId         String
  ownerAddress  String
  acquiredAt    DateTime @default(now())
  price         Float?
  transactionHash String?
  previousOwner String?
  isCurrentOwner Boolean @default(true)

  nft NFTMint @relation(fields: [nftId], references: [id], onDelete: Cascade)

  @@index([nftId])
  @@index([ownerAddress])
  @@map("nft_ownership")
}

model NFTRoyalty {
  id              String   @id @default(cuid())
  nftId           String
  creatorAddress  String
  amount          Float
  transactionHash String?
  paidAt          DateTime @default(now())

  nft NFTMint @relation(fields: [nftId], references: [id], onDelete: Cascade)

  @@index([nftId])
  @@index([creatorAddress])
  @@map("nft_royalties")
}

// ============================================
// AI CO-PILOT CHAT INTERFACE
// ============================================

model AIChatSession {
  id           String   @id @default(cuid())
  userId       String
  projectId    String?
  slideId      String?
  title        String?
  context      Json?    // Session context for AI
  messages     AIChatMessage[]
  status       String   @default("active") // active, archived
  totalTokens  Int      @default(0)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  @@index([userId])
  @@index([projectId])
  @@map("ai_chat_sessions")
}

model AIChatMessage {
  id           String   @id @default(cuid())
  sessionId    String
  role         String   // user, assistant, system
  content      String   @db.Text
  tokens       Int      @default(0)
  metadata     Json?    // Action metadata, suggestions
  feedback     String?  // thumbs_up, thumbs_down
  createdAt    DateTime @default(now())

  session AIChatSession @relation(fields: [sessionId], references: [id], onDelete: Cascade)

  @@index([sessionId])
  @@map("ai_chat_messages")
}

// ============================================
// LIVE Q&A WITH AI MODERATION
// ============================================

model LiveQASession {
  id              String   @id @default(cuid())
  projectId       String
  hostUserId      String
  title           String?
  status          String   @default("pending") // pending, live, paused, ended
  moderationLevel String   @default("medium") // low, medium, high, strict
  anonymousAllowed Boolean @default(true)
  maxQuestions    Int?
  questions       LiveQuestion[]
  aiSummary       String?  @db.Text
  participantCount Int     @default(0)
  startedAt       DateTime?
  endedAt         DateTime?
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@index([projectId])
  @@index([hostUserId])
  @@index([status])
  @@map("live_qa_sessions")
}

model LiveQuestion {
  id            String   @id @default(cuid())
  sessionId     String
  userId        String?
  anonymousName String?
  content       String   @db.Text
  status        String   @default("pending") // pending, approved, rejected, answered, spam
  moderationScore Float? // AI moderation score
  moderationReason String?
  upvotes       Int      @default(0)
  isHighlighted Boolean  @default(false)
  isPinned      Boolean  @default(false)
  answer        String?  @db.Text
  answeredBy    String?
  answeredAt    DateTime?
  createdAt     DateTime @default(now())

  session LiveQASession @relation(fields: [sessionId], references: [id], onDelete: Cascade)

  @@index([sessionId])
  @@index([status])
  @@map("live_questions")
}

// ============================================
// CROSS-PLATFORM SYNC & OFFLINE
// ============================================

model OperationalTransform {
  id            String   @id @default(cuid())
  projectId     String
  userId        String
  operation     String   // insert, delete, update, move
  path          String   // JSON path to the changed element
  oldValue      Json?
  newValue      Json?
  vectorClock   Json     // Vector clock for conflict resolution
  serverSeq     Int      // Server sequence number
  clientSeq     Int      // Client sequence number
  isApplied     Boolean  @default(false)
  conflictWith  String?  // ID of conflicting operation
  resolvedBy    String?  // merge, theirs, ours
  createdAt     DateTime @default(now())

  @@index([projectId])
  @@index([userId])
  @@index([serverSeq])
  @@map("operational_transforms")
}

model DeviceSync {
  id           String   @id @default(cuid())
  userId       String
  deviceId     String   @unique
  deviceName   String?
  deviceType   String   // mobile, tablet, desktop, web
  platform     String?  // ios, android, windows, macos, web
  lastSyncAt   DateTime @default(now())
  syncVersion  Int      @default(0)
  offlineData  Json?    // Cached offline changes
  isOnline     Boolean  @default(true)
  pushToken    String?  // For push notifications
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  @@index([userId])
  @@index([deviceId])
  @@map("device_syncs")
}

// ============================================
// PREDICTIVE ANALYTICS
// ============================================

model PredictiveInsight {
  id              String   @id @default(cuid())
  projectId       String
  type            String   // engagement, dropoff, length, visual
  prediction      Json     // Prediction details
  confidence      Float    // 0-1 confidence score
  recommendations Json     // Array of recommendations
  mlModelVersion  String?
  dataPoints      Int      @default(0)
  isActioned      Boolean  @default(false)
  createdAt       DateTime @default(now())
  expiresAt       DateTime?

  @@index([projectId])
  @@index([type])
  @@map("predictive_insights")
}

model EngagementPrediction {
  id              String   @id @default(cuid())
  projectId       String
  slideId         String?
  predictedScore  Float    // 0-100
  actualScore     Float?   // After measurement
  factors         Json     // Contributing factors
  suggestions     Json     // Improvement suggestions
  calculatedAt    DateTime @default(now())
  measuredAt      DateTime?

  @@index([projectId])
  @@index([slideId])
  @@map("engagement_predictions")
}

// ============================================
// AUDIENCE SENTIMENT ANALYSIS
// ============================================

model SentimentSession {
  id              String   @id @default(cuid())
  projectId       String
  presenterId     String
  status          String   @default("pending") // pending, active, completed
  webcamEnabled   Boolean  @default(false)
  feedbackEnabled Boolean  @default(true)
  snapshots       SentimentSnapshot[]
  overallSentiment Json?
  heatmapData     Json?    // Confusion vs engagement heatmap
  startedAt       DateTime?
  endedAt         DateTime?
  createdAt       DateTime @default(now())

  @@index([projectId])
  @@index([presenterId])
  @@map("sentiment_sessions")
}

model SentimentSnapshot {
  id           String   @id @default(cuid())
  sessionId    String
  slideIndex   Int
  timestamp    DateTime @default(now())
  sentiment    String   // positive, neutral, negative, confused, engaged
  confidence   Float
  faceCount    Int      @default(0)
  emotions     Json?    // Detailed emotion breakdown
  feedbackData Json?    // Text/poll feedback
  
  session SentimentSession @relation(fields: [sessionId], references: [id], onDelete: Cascade)

  @@index([sessionId])
  @@index([slideIndex])
  @@map("sentiment_snapshots")
}

// ============================================
// PERSONALIZED LEARNING PATHS
// ============================================

model LearningPath {
  id              String   @id @default(cuid())
  userId          String
  projectId       String
  title           String
  description     String?  @db.Text
  modules         LearningModule[]
  prerequisites   String[] @default([])
  estimatedTime   Int?     // minutes
  difficulty      String   @default("beginner") // beginner, intermediate, advanced
  category        String?
  isPublished     Boolean  @default(false)
  completionRate  Float    @default(0)
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@index([userId])
  @@index([projectId])
  @@map("learning_paths")
}

model LearningModule {
  id            String   @id @default(cuid())
  pathId        String
  slideId       String?
  title         String
  content       String?  @db.Text
  order         Int
  type          String   @default("lesson") // lesson, quiz, assignment, resource
  resources     Json?    // Additional resources
  quizConfig    Json?    // Quiz configuration
  completionCriteria Json? // What counts as complete
  createdAt     DateTime @default(now())

  path LearningPath @relation(fields: [pathId], references: [id], onDelete: Cascade)
  progress LearnerProgress[]

  @@index([pathId])
  @@map("learning_modules")
}

model LearnerProgress {
  id            String   @id @default(cuid())
  userId        String
  moduleId      String
  pathId        String
  status        String   @default("not_started") // not_started, in_progress, completed
  progress      Float    @default(0) // 0-100
  quizScore     Float?
  timeSpent     Int      @default(0) // seconds
  attempts      Int      @default(0)
  lastAccessedAt DateTime?
  completedAt   DateTime?
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  module LearningModule @relation(fields: [moduleId], references: [id], onDelete: Cascade)

  @@unique([userId, moduleId])
  @@index([userId])
  @@index([pathId])
  @@map("learner_progress")
}

// ============================================
// SIGN LANGUAGE AVATARS
// ============================================

model SignLanguageConfig {
  id              String   @id @default(cuid())
  projectId       String
  enabled         Boolean  @default(false)
  language        String   @default("ASL") // ASL, BSL, ISL, etc.
  avatarStyle     String   @default("realistic") // realistic, cartoon, minimal
  avatarPosition  String   @default("bottom-right")
  avatarSize      String   @default("medium") // small, medium, large
  backgroundColor String?
  transparency    Float    @default(0.9)
  autoGenerate    Boolean  @default(true)
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  translations SignLanguageTranslation[]

  @@unique([projectId])
  @@index([projectId])
  @@map("sign_language_configs")
}

model SignLanguageTranslation {
  id            String   @id @default(cuid())
  configId      String
  slideId       String
  blockId       String?
  sourceText    String   @db.Text
  signSequence  Json     // Array of sign animations
  videoUrl      String?
  duration      Float?   // seconds
  status        String   @default("pending") // pending, processing, completed, failed
  createdAt     DateTime @default(now())

  config SignLanguageConfig @relation(fields: [configId], references: [id], onDelete: Cascade)

  @@index([configId])
  @@index([slideId])
  @@map("sign_language_translations")
}

// ============================================
// COGNITIVE ACCESSIBILITY
// ============================================

model CognitiveAccessibilityProfile {
  id                  String   @id @default(cuid())
  userId              String   @unique
  dyslexiaMode        Boolean  @default(false)
  dyslexiaFont        String   @default("OpenDyslexic")
  reducedMotion       Boolean  @default(false)
  simplifiedLayout    Boolean  @default(false)
  highContrast        Boolean  @default(false)
  largerText          Boolean  @default(false)
  textSpacing         Float    @default(1.0)
  lineHeight          Float    @default(1.5)
  focusHighlight      Boolean  @default(true)
  voiceNavigation     Boolean  @default(false)
  readingGuide        Boolean  @default(false)
  colorOverlay        String?  // Color for dyslexia overlay
  preferences         Json?    // Additional preferences
  createdAt           DateTime @default(now())
  updatedAt           DateTime @updatedAt

  @@index([userId])
  @@map("cognitive_accessibility_profiles")
}

// ============================================
// UNIVERSAL DESIGN CHECKER
// ============================================

model UniversalDesignReport {
  id                String   @id @default(cuid())
  projectId         String
  overallScore      Float    // 0-100
  accessibilityScore Float
  culturalScore     Float
  readabilityScore  Float
  issues            Json     // Array of issues
  culturalIssues    CulturalIssue[]
  suggestions       Json     // Improvement suggestions
  targetRegions     String[] @default([])
  checkedAt         DateTime @default(now())

  @@index([projectId])
  @@map("universal_design_reports")
}

model CulturalIssue {
  id          String   @id @default(cuid())
  reportId    String
  slideId     String?
  blockId     String?
  type        String   // color_symbolism, imagery, text, gesture
  severity    String   // low, medium, high, critical
  region      String   // Affected region/culture
  description String   @db.Text
  suggestion  String?  @db.Text
  isResolved  Boolean  @default(false)
  createdAt   DateTime @default(now())

  report UniversalDesignReport @relation(fields: [reportId], references: [id], onDelete: Cascade)

  @@index([reportId])
  @@map("cultural_issues")
}

// ============================================
// THIRD-PARTY API & SDK
// ============================================

model APIKey {
  id              String   @id @default(cuid())
  userId          String
  organizationId  String?
  name            String
  key             String   @unique
  hashedKey       String   // For secure storage
  permissions     String[] @default([])
  rateLimit       Int      @default(1000) // requests per hour
  usageCount      Int      @default(0)
  lastUsedAt      DateTime?
  expiresAt       DateTime?
  isActive        Boolean  @default(true)
  metadata        Json?
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  usageLogs APIUsageLog[]

  @@index([userId])
  @@index([organizationId])
  @@index([key])
  @@map("api_keys")
}

model APIUsageLog {
  id          String   @id @default(cuid())
  apiKeyId    String
  endpoint    String
  method      String
  statusCode  Int
  latency     Int      // milliseconds
  requestSize Int?
  responseSize Int?
  ipAddress   String?
  userAgent   String?
  error       String?
  createdAt   DateTime @default(now())

  apiKey APIKey @relation(fields: [apiKeyId], references: [id], onDelete: Cascade)

  @@index([apiKeyId])
  @@index([endpoint])
  @@index([createdAt])
  @@map("api_usage_logs")
}

// ============================================
// WHITE-LABEL SDK
// ============================================

model SDKConfiguration {
  id              String   @id @default(cuid())
  organizationId  String   @unique
  name            String
  version         String   @default("1.0.0")
  isHeadless      Boolean  @default(false)
  customBranding  Json?    // Logo, colors, fonts
  customDomain    String?
  allowedOrigins  String[] @default([])
  features        Json     // Enabled features
  theme           Json?    // Theme overrides
  apiEndpoint     String?
  webhookUrl      String?
  isActive        Boolean  @default(true)
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  instances SDKInstance[]

  @@index([organizationId])
  @@map("sdk_configurations")
}

model SDKInstance {
  id            String   @id @default(cuid())
  configId      String
  instanceKey   String   @unique
  domain        String
  status        String   @default("active") // active, suspended, revoked
  usageStats    Json?
  lastActiveAt  DateTime?
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  config SDKConfiguration @relation(fields: [configId], references: [id], onDelete: Cascade)

  @@index([configId])
  @@index([instanceKey])
  @@map("sdk_instances")
}

// ============================================
// IOT DEVICE INTEGRATION
// ============================================

model IoTDevice {
  id            String   @id @default(cuid())
  userId        String
  deviceType    String   // alexa, google_home, fitbit, custom
  deviceId      String   @unique
  name          String
  capabilities  String[] @default([])
  authToken     String?
  status        String   @default("connected") // connected, disconnected, error
  lastPing      DateTime?
  metadata      Json?
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  commands IoTCommand[]

  @@index([userId])
  @@index([deviceId])
  @@map("iot_devices")
}

model IoTCommand {
  id            String   @id @default(cuid())
  deviceId      String
  projectId     String?
  command       String   // next_slide, previous_slide, pause, resume, goto_slide
  parameters    Json?
  status        String   @default("pending") // pending, executed, failed
  executedAt    DateTime?
  createdAt     DateTime @default(now())

  device IoTDevice @relation(fields: [deviceId], references: [id], onDelete: Cascade)

  @@index([deviceId])
  @@index([projectId])
  @@map("iot_commands")
}

// ============================================
// ECO-FRIENDLY MODE & SUSTAINABILITY
// ============================================

model EcoReport {
  id                String   @id @default(cuid())
  projectId         String
  userId            String
  ecoScore          Float    // 0-100
  fileSize          Int      // bytes
  compressedSize    Int?     // bytes after optimization
  estimatedEnergy   Float?   // kWh per view
  animationCount    Int      @default(0)
  heavyMediaCount   Int      @default(0)
  optimizations     Json     // Applied optimizations
  suggestions       Json     // Suggested improvements
  createdAt         DateTime @default(now())

  @@index([projectId])
  @@index([userId])
  @@map("eco_reports")
}

model CarbonFootprint {
  id              String   @id @default(cuid())
  userId          String
  projectId       String?
  periodStart     DateTime
  periodEnd       DateTime
  dataTransferKb  Float    @default(0)
  viewCount       Int      @default(0)
  deviceViews     Json?    // Breakdown by device type
  regionViews     Json?    // Breakdown by region
  estimatedCO2g   Float    @default(0) // grams of CO2
  offset          Float    @default(0) // Offset purchased
  createdAt       DateTime @default(now())

  @@index([userId])
  @@index([projectId])
  @@index([periodStart, periodEnd])
  @@map("carbon_footprints")
}

// ============================================
// PRESENTER WELLNESS TOOLS
// ============================================

model WellnessSession {
  id              String   @id @default(cuid())
  userId          String
  projectId       String?
  status          String   @default("active") // active, paused, completed
  webcamEnabled   Boolean  @default(false)
  duration        Int      @default(0) // seconds
  breaksTaken     Int      @default(0)
  hydrationReminders Int   @default(0)
  metrics         WellnessMetric[]
  summary         Json?
  recommendations Json?
  startedAt       DateTime @default(now())
  endedAt         DateTime?

  @@index([userId])
  @@index([projectId])
  @@map("wellness_sessions")
}

model WellnessMetric {
  id            String   @id @default(cuid())
  sessionId     String
  timestamp     DateTime @default(now())
  metricType    String   // stress, fatigue, voice_strain, posture
  value         Float    // 0-100
  raw           Json?    // Raw sensor/analysis data
  alert         String?  // break_suggested, hydrate, posture_check
  acknowledged  Boolean  @default(false)

  session WellnessSession @relation(fields: [sessionId], references: [id], onDelete: Cascade)

  @@index([sessionId])
  @@index([metricType])
  @@map("wellness_metrics")
}
